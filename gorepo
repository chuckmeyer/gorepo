#!/usr/bin/env zsh

# gorepo - quickly navigate to GitHub repositories with fuzzy matching
# Usage: gorepo [pattern]
#   - With pattern: opens fzf with pre-filtered results if no exact match
#   - Without pattern: opens fzf with all repos
#   - Press Tab while typing to trigger interactive selection

# ============================================================================
# Configuration - Edit this path to match your GitHub directory location
# ============================================================================
typeset -g GOREPO_DIR="$HOME/Documents/GitHub"

# Helper function: Get list of all repositories
_gorepo_get_repos() {
    local -a repos=("root")

    [[ -d "$GOREPO_DIR" ]] || return 1

    for dir in "$GOREPO_DIR"/*(/N); do
        repos+=("${dir:t}")
    done

    # Return repos via stdout
    printf '%s\n' "${repos[@]}"
}

# Helper function: Navigate to a repository
_gorepo_navigate() {
    local repo="$1"

    if [[ "$repo" == "root" ]]; then
        cd "$GOREPO_DIR" && echo "→ $GOREPO_DIR"
    else
        cd "$GOREPO_DIR/$repo" && echo "→ $GOREPO_DIR/$repo"
    fi
}

# Main gorepo function
gorepo() {
    local pattern="$1"

    # Check if GitHub directory exists
    if [[ ! -d "$GOREPO_DIR" ]]; then
        echo "Error: GitHub directory not found at $GOREPO_DIR"
        return 1
    fi

    # Get all repositories as an array
    local -a repos
    repos=(${(f)"$(_gorepo_get_repos)"})

    # If no repos found (only "root" exists)
    if [[ ${#repos[@]} -eq 1 ]]; then
        echo "No repositories found in $GOREPO_DIR"
        return 1
    fi

    # If pattern provided, check for exact match first
    if [[ -n "$pattern" ]] && (( ${repos[(Ie)$pattern]} )); then
        _gorepo_navigate "$pattern"
        return $?
    fi

    # No exact match or no pattern, use fzf for interactive selection
    local selected
    selected=$(printf '%s\n' "${repos[@]}" | fzf \
        ${pattern:+--query="$pattern"} \
        --height=40% \
        --reverse \
        --border \
        --prompt="Select repo > ")

    # Navigate to selected repository if one was chosen
    [[ -n "$selected" ]] && _gorepo_navigate "$selected"
}

# Custom widget for tab completion using fzf
_gorepo_fzf_completion() {
    local tokens=(${(z)LBUFFER})

    # Check if this is a gorepo command
    if [[ ${#tokens[@]} -eq 0 ]] || [[ ${tokens[1]} != "gorepo" ]]; then
        zle expand-or-complete
        return
    fi

    # Extract pattern if provided
    local pattern="${tokens[2]:-}"

    # Get all repositories as an array
    local -a repos
    repos=(${(f)"$(_gorepo_get_repos)"})

    # Check for exact match if pattern is provided
    if [[ -n "$pattern" ]] && (( ${repos[(Ie)$pattern]} )); then
        BUFFER="gorepo $pattern"
        zle accept-line
        return
    fi

    # No exact match, run fzf for selection
    local selected
    selected=$(printf '%s\n' "${repos[@]}" | fzf \
        ${pattern:+--query="$pattern"} \
        --height=40% \
        --reverse \
        --border \
        --prompt="Select repo > " \
        </dev/tty)

    # If something was selected, update command line and execute
    if [[ -n "$selected" ]]; then
        BUFFER="gorepo $selected"
        zle accept-line
    else
        zle redisplay
    fi
}

# Create and register the widget
zle -N _gorepo_fzf_completion

# Save the original tab widget
typeset -g _gorepo_original_tab_widget="${$(bindkey '^I')##* }"

# Create a wrapper that decides whether to use fzf or default completion
_gorepo_tab_wrapper() {
    local tokens=(${(z)LBUFFER})
    if [[ ${#tokens[@]} -gt 0 ]] && [[ ${tokens[1]} == "gorepo" ]]; then
        _gorepo_fzf_completion
    else
        zle ${_gorepo_original_tab_widget}
    fi
}

# Create and bind the wrapper widget to Tab
zle -N _gorepo_tab_wrapper
bindkey '^I' _gorepo_tab_wrapper
